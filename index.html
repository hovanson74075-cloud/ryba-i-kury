<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Рыба и Куры — доставка на дом</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="container">
    <h1>Рыба и Куры</h1>
    <p class="subtitle">Свежая рыба и курица с доставкой на дом</p>
    <div class="toolbar">
      <!-- Новые табы категорий (визуально разделяют контент) -->
      <nav class="tabs" role="tablist" aria-label="Категории">
        <button type="button" data-category="all" class="active">Все</button>
        <button type="button" data-category="fish">Рыба</button>
        <button type="button" data-category="chicken">Курица</button>
      </nav>

      <!-- Скрытый select оставляем для совместимости с app.js -->
      <select id="categoryFilter" aria-hidden="true" style="display:none;">
        <option value="all">Все категории</option>
        <option value="fish">Рыба</option>
        <option value="chicken">Курица</option>
      </select>

      <input id="search" placeholder="Поиск по товарам..." />
      <button id="viewCartBtn">Корзина (<span id="cartCount">0</span>)</button>
    </div>
  </header>

  <main class="container">
    <section id="grid" class="grid"></section>
  </main>

  <dialog id="cartDialog">
    <h3>Ваш заказ (через WhatsApp)</h3>
    <div id="cartItems"></div>
    <div class="totals">
      <div>Сумма: <strong id="subtotal">0</strong> ₽</div>
      <div>Доставка: <strong id="delivery">0</strong> ₽</div>
      <div class="grand">Итого: <strong id="grand">0</strong> ₽</div>
    </div>
    <form id="checkoutForm" class="checkout">
      <input name="name" placeholder="Имя" required />
      <input name="phone" placeholder="Телефон" required />
      <input name="address" placeholder="Адрес доставки" required />
      <textarea name="note" placeholder="Комментарий к заказу"></textarea>
      <button type="submit">Оформить в WhatsApp</button>
      <button type="button" id="closeCart">Закрыть</button>
    </form>
    <p class="muted small">Статический режим GitHub Pages: заявка откроется в WhatsApp с уже подставленным текстом.</p>
  </dialog>

  <footer class="container muted">
    <small>© 2025 Рыба и Куры.</small>
  </footer>

  <script src="settings.js"></script>
  <script src="app.js"></script>

  <!-- Скрипт синхронизирует табы с существующим фильтром (не меняет логику app.js) -->
  <script>
    (function(){
      const tabs = document.querySelectorAll('.tabs button');
      const select = document.getElementById('categoryFilter');

      function setActiveTab(category) {
        tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.category === category));
      }

      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          const cat = btn.dataset.category;
          select.value = cat;
          select.dispatchEvent(new Event('change', { bubbles: true }));
          setActiveTab(cat);
        });
      });

      // Установить начальный активный таб по значению select (если app.js меняет select на старте)
      document.addEventListener('DOMContentLoaded', () => {
        setActiveTab(select.value || 'all');
      });
    })();
  </script>

  <!-- Добавлен обработчик отправки формы: формирует текст заказа и открывает WhatsApp -->
  <script>
    (function () {
      // Укажите номер получателя (можно с + или без)
      const RAW_PHONE = '+7 927 969 44 43';

      function normalizePhone(raw) {
        // Оставляем только цифры
        let digits = (raw || '').toString().replace(/\D/g, '');
        // Если россиянин ввёл 8xxx — заменить на 7xxx
        if (digits.length === 11 && digits.startsWith('8')) digits = '7' + digits.slice(1);
        return digits;
      }

      const PHONE = normalizePhone(RAW_PHONE); // -> "79279694443"
      const form = document.getElementById('checkoutForm');
      if (!form) return;

      function collectItemsText() {
        const itemsContainer = document.getElementById('cartItems');
        if (!itemsContainer) return '—';
        const rows = itemsContainer.querySelectorAll('[data-name], .cart-row, .cart-item, li, div');
        const lines = [];
        rows.forEach(r => {
          const n = (r.dataset.name) || (r.querySelector?.('.item-name')?.textContent) || (r.querySelector?.('strong')?.textContent) || r.textContent;
          if (!n) return;
          const q = r.dataset.qty || r.querySelector?.('.item-qty')?.textContent || '';
          const p = r.dataset.price || r.querySelector?.('.item-price')?.textContent || '';
          const parts = [n.toString().trim()];
          if (q) parts.push('x' + q.toString().trim());
          if (p) parts.push(p.toString().trim());
          lines.push(parts.join(' '));
        });
        return lines.length ? lines.join('\n') : '—';
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const name = (form.name?.value || '').trim();
        const phone = (form.phone?.value || '').trim();
        const address = (form.address?.value || '').trim();
        const note = (form.note?.value || '').trim();

        const itemsText = collectItemsText();
        const subtotal = (document.getElementById('subtotal')?.textContent || '').trim();
        const delivery = (document.getElementById('delivery')?.textContent || '').trim();
        const grand = (document.getElementById('grand')?.textContent || '').trim();

        const message =
`Новый заказ
Имя: ${name || '-'}
Телефон: ${phone || '-'}
Адрес: ${address || '-'}

Товары:
${itemsText}

Сумма: ${subtotal || '-'} ₽
Доставка: ${delivery || '-'} ₽
Итого: ${grand || '-'} ₽

Примечание: ${note || '-'}`;

        const encoded = encodeURIComponent(message);

        // Выбираем URL: wa.me работает и на десктопе и на мобильных, но для десктопа иногда удобнее web.whatsapp.com/send
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const base = isMobile ? 'https://wa.me/' : 'https://web.whatsapp.com/send?phone=';
        const url = isMobile
          ? `https://wa.me/${PHONE}?text=${encoded}`
          : `https://web.whatsapp.com/send?phone=${PHONE}&text=${encoded}`;

        // Открыть новое окно/вкладку (пользователь подтвердит отправку в своём WhatsApp)
        window.open(url, '_blank');

        // Закрыть диалог корзины, если используется <dialog>
        const dialog = document.getElementById('cartDialog');
        try { if (dialog && typeof dialog.close === 'function') dialog.close(); } catch (err) {}

        // Если хотите — можно показать пользователю ссылку или уведомление об успешном создании заявки
        // alert('Откроется WhatsApp для подтверждения и отправки заказа.');
      });
    })();
  </script>
</body>
</html>
